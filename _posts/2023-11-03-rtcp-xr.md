---
layout: post
title: rtcp xr
date: 2023-11-03 23:10:00 +0800
author: Fisher
pin: True
meta: Post
categories: webrtc rtcp rtt
---


* content
{:toc}

---

## 0. 前言

**有了 sr，rr，为什么需要接收端计算方式?**

这两种方式计算RTT的原理都一样。那么为什么需要接收端计算方式，这是因为**在一些场景，两个端点间一个只发媒体数据，一个只接收**，例如客户端与SFU服务器间。假设客户端与SFU服务器上行推流场景，客户端推流，服务端收流，这种场景下作为接收端的服务端并不会发送SR，导致无法计算RTT。于是就**有了通过RTCP XR在接收端计算这种方式**。



## 1. WebRTC RTCP XR 

RTCP扩展报告(XR，Extend Report)用于补充RTCP 的发送方报告 (SR) 和接收方报告 (RR) 数据包的报告块中的六个统计信息。

| Value | Name | Name                               | Description                | Reference                                                    |
| ----- | ---- | ---------------------------------- | -------------------------- | ------------------------------------------------------------ |
| 1     | RRT  | Receiver Reference Time            | 接收方参考时间             | [rfc3611#section-4.4](https://tools.ietf.org/html/rfc3611#section-4.4) |
| 2     | DLSR | Delay since the last Sender Report | 自上次发送方报告以来的延迟 | [rfc3611#section-4.5](https://tools.ietf.org/html/rfc3611#section-4.5) |



## 2. 接收方参考时间（RRT）

```less
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |V=2|P|reserved |   PT=XR=207   |             length            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                              SSRC                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     BT=4      |   reserved    |       block length = 2        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |              NTP timestamp, most significant word             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |             NTP timestamp, least significant word             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

1. block type(BT)：块类型，该报告块为常数4
2. block length：块长度，2*32bit
3. NTP timestamp：64bit的NTP系统时间



## 3. 自上次发送方报告以来的延迟（DLSR）

```less
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |V=2|P|reserved |   PT=XR=207   |             length            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                              SSRC                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     BT=5      |   reserved    |         block length          |
   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
   |                 SSRC_1 (SSRC of first receiver)               | sub-
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ block
   |                         last RR (LRR)                         |   1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                   delay since last RR (DLRR)                  |
   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
   |                 SSRC_2 (SSRC of second receiver)              | sub-
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ block
   :                               ...                             :   2
   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
```

1. block type(BT)：块类型，该报告块为常数5
2. block length：块长度，3*32bit
3. last RR(LRR)：最后接收的RRT包里的NTP时间戳，只截取了中间的32bit。如果还没有收到RRT，则该字段设置为0。
4. delay since last RR(DLRR)：自最后接收RRT包以来到发送DLSR之间的延迟，以 1/65536 秒为单位

## 4. ??? 计算RTT

接收方发送RTCP-XR RRT后，发送方在下次的RTCP中携带RTCP-XR DLSR，可以使接收方估算出网络的RTT参数。

客户端推流，服务端收流，这种场景下作为接收端的服务端并不会发送SR，导致无法计算RTT，用xr就可以。

- 服务端， 接收数据流端，发送 RTCP-XR RRT； 
- 客户端，发送数据流端，发送方在下次的RTCP中携带RTCP-XR DLSR，
- 服务端，作为接收方，就可以估算出网络的RTT参数；

计算方式和sr，rr一样，后面增加图。



## 参考

[流媒体协议分析之webrtc之rtcp](https://blog.csdn.net/u012794472/article/details/128286482)

