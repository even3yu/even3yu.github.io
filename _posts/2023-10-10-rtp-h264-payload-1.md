---
layout: post
title: h264 介绍
date: 2023-10-10 12:30:00 +0800
author: Fisher
pin: True
meta: Post
categories: webrtc rtp
---


* content
{:toc}

---

## 1. [H264](https://so.csdn.net/so/search?q=H264&spm=1001.2101.3001.7020)介绍

### 1.1 I,P,B帧

I帧：关键帧，采用帧内压缩技术，自身可以通过视频解压算法解压成一张单独的完整图片。
P帧：向前参考帧，在压缩时，只参考前面已经处理的帧（只需要参考前面的I帧或P帧），采用帧音压缩技术。
B帧：双向参考帧，在压缩时，他既参考前面的帧，又参考他后面的帧（需要同时参考前面和后面的I帧或P帧），采用帧间压缩技术。

> **在baseline编码规格下，无B帧，在main profile规格下一般有B帧**，通常来说B帧参与编码会提高压缩率，降低帧大小，但是会增加编解码复杂性。

### 1.2 图像序列GOP

两个I帧之间是个图像序列，在一个图像序列中只有一个I帧，如图：

![在这里插入图片描述]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/gop.png)

在H264基准类中，仅使用I帧和P帧以实现低延时，因此是网络摄像机和视频[编码器](https://so.csdn.net/so/search?q=编码器&spm=1001.2101.3001.7020)的理想选择。



## 2. H264的结构图

![img]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/h264-struct.png)



## 3. H264原始码流结构

h264功能分为两层，VCL视频编码层，和NAL网络提取层。

![分层图及基本概念]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/vcl+nal.png)

- VCL：包括核心压缩引擎和块，宏块和片的语法级别定义，设计目标是尽可能地独立于网络进行高效的编码。
- NAL：负责将VCL产生的比特字符串适配到各种各样的网络和多元环境中，覆盖了所有片级以上的语法级别。



### 3.1 H264 Stream

VCL数据传输或者存储之前，会被映射到一个NALU中，H264数据包含一个个的NALU，如图

![在这里插入图片描述]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/nalu-seq.png)



### 3.2 NALU

NAL单元（NAL Unit，简称NALU）。NULU由1个NAL头（NAL Header）和1个RBSP（或EBSP）组成。

> 一个NALU = 一组对应视频编码的NALU头部信息 + 一个原始字节序列负荷（RBSP,RAW Byte Sequence Paload）
> 一个原始的NALU单元结构包含:【start code】 + [NALU head] + [NALU payload] 三部分，其中start code是一个NALU单元开始，

NAL单元格式如图：
![在这里插入图片描述]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/nalu.png)
H.264的编码视频序列包括一系列的NAL单元，每个NAL单元包含一个RBSP。编码片（包括数据分割篇IDR片）和序列RBSP结束符被定义为VCL NAL单元，其余为NAL单元。典型的RBSP单元序列如图2所示。每个单元都按独立的NAL单元传送。每个单元都按独立的NAL单元传送。单元的信息头（一个字节)定义了RBSP单元的类型，NAL单元其余部分为RBSP数据。

![NALU]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/nalu-header.png)

#### 3.2.1 RBSP

RAW Byte Sequence Paload。

![在这里插入图片描述]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/rbsp.png)

#### 3.2.2 NAL单元 HEADER

![在这里插入图片描述]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/nalu-header2.png)

### 3.3 SODB

原始数据比特串（String Of Data Bit）。由编码器直接输出的原始编码数据，即VCL数据。 

### 3.4 RBSP

原始字节序列载荷（Raw Byte Sequence Payload）。在SODB的后面增加了若干结尾比特（RBSP trailing bits，1个为’1’的bit和若干为’0’的bit），以使SODB长度为整数字节。 

### 3.5 EBSP

扩展字节序列载荷（Extension Byte Sequence Payload）。在RBSP的基础上增加了仿校验字节（0x03）。 **增加仿校验字节原因是**：将NALU添加到H.264码流上时，需要在每个NALU之前添加开始码（StartCodePrefix）。 

#### 3.5.1 添加StartCodePrefix的规则

- 如果该NALU对应的slice为一帧的开始则StartCodePrefix为`0x00 0x00 0x00 0x01`这4个字节；或者StartCodePrefix为`0x00 0x00 0x01`这3个字节 。
- 同时H264规定，当检测到0x000000时，也可以表示当前NALU的结束。
- 为了使NALU主体中不包含与开始码相冲突的字节序列，在编码时，每遇到两个字节连续为0x00，就在这两个字节后面插入一个字节的0x03。解码时将0x03去掉，称为脱壳操作。 如下图，就是一帧的EBSP数据。

![img]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/ebsp-data.png)



### 3.6 小结

H264流 = NALU + NALU + ... + NALU； 其实每个NALU开始前都有起始码，0x00 00 01,0x00 00 00 01;

NALU = NAL Header + RBSP;

RBSP = SPS / SEI / PPS / I / 图片界定符 / P / P / ...;

NAL Header = F+R+T;

![分层图及基本概念]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/vcl+nal.png)



## 4. NAL单元

每个NAL单元是一个一定语法元素的可变长字节字符串，包括包含一个字节的头信息（用来表示数据类型），以及若干整数字节的负荷数据，一个NAL单元可以携带一个编码片，A/B/C型数据分割或一个学列或一个图像集。

NALU头有一个字节组成，它的语法如下：
![在这里插入图片描述]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/nalu-header2.png)

NAL单元按RTP序列，其中T为负荷数据类型，占5Bit; R为重要性指示位，占2bit; 最后的F为禁止位，占1bit。具体如下：

- NALU类型位：表示NALU的32种不同类型的特征，类型1-12是H.264定义的，类型24-31是用于H.264以外的，RTP负荷规范使用这其中的一些值来定义包聚合和分裂，其他值位H.264保留。
- 重要性只是位：用于在重构过程中标记一个NAL单元的重要性，值越大，越重要。值位0表示这个NAL单元没有用于预测，因此可被解码器抛弃而不会有错误扩散；值高于0表示NAL单元要用于无漂移重构，且值越高，对此NAL单元丢失的影响越大。
- 禁止位：编码中默认值为0，当网络识别此单元中存在比特错误时，可将其设为1，以便接收方丢掉该单元，主要用于适应不同种类的网络环境（比如有线和无线相结合的环境）。

```c
264常见的帧头数据为：

00 00 00 01 67 (SPS) 0110 0111

00 00 00 01 68 (PPS) 0110 1000

00 00 00 01 65 (IDR帧) 0110 0101

00 00 00 01 61 (P帧) 0110 0001
```

上述的67，68，65，61，还有41等，都是该NALU的识别等级。
F:禁止位，0表示正常，1表示错误，一般都是0；
NRI：重要级别，11表示非常重要。
TYPE:表示该NALU的类型是什么，见下表，由此可知7位序列参数集（SPS）,8为图像参数集（PPS）,5代表I帧，1代表非I帧。
由此 可知。61和41其实都是P帧（type值为1）.重要级别不一样，（它们的NRI一个是11BIN，一个是10BIN）。
NALU类型是我们判断帧类型的利器，从官方文档中得出下图：
![在这里插入图片描述]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/nalu-heaer-type.png)



## 5. !!! H264帧判断

以下是截取的H264视频流的二进制数据，结合此二进制数据，我们来分析下其帧类型

![img]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/h264-stream-data.png) 

- 00000001 09，其中00000001是帧起始位标识，09是nalu header，二进制为00001001，F(7位）为0标识非禁止，NRI（5 ~ 6位）为0标识可丢弃帧，type（0 ~ 4位）为9，**表示分隔符**，此帧可丢弃，表示分隔符
- 00000001 67，同上面的分析，NALU头为67，二进制为01100111，F=0，NRI=3，type=7，**帧类型为SPS帧**，非常重要不可丢弃
- 00000001 68，NALU头为68，二进制为01101000，F=0，NRI=3，type=8，**帧类型为PPS帧**，非常重要不可丢弃
- 00000001 06，NALU头为06，二进制为00000110，F=0，NRI=0，type=6，**帧类型为SEI**，可丢弃
- 00000001 65，NALU头为65，二进制为01100101，F=0，NRI=3，type=5，**帧类型为I帧**，非常重要不可丢弃

从上上面的分析可以看出，IDR（SPS/PPS/I)帧通常一起出现，极少数编码单独出现I帧，但是IDR与I帧单独出现也符合规范。
如下为P帧的帧头，可按照上述方式进行解析。

![img]({{ site.url }}{{ site.baseurl }}/images/rtp-h264-payload-1.assets/h264-stream-data-2.png)



## 参考

[RTP(载荷H264码流)基础知识](https://blog.csdn.net/u014415274/article/details/124103377?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168848104816782425190488%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168848104816782425190488&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-124103377-null-null.142^v88^insert_down38v5,239^v2^insert_chatgpt&utm_term=h264%20rtp&spm=1018.2226.3001.4187)

[H264码流RTP封装方式详解](https://blog.csdn.net/m0_60259116/article/details/126626423?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168848104816782425190488%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168848104816782425190488&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-126626423-null-null.142^v88^insert_down38v5,239^v2^insert_chatgpt&utm_term=h264%20rtp&spm=1018.2226.3001.4187)