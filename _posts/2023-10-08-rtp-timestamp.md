---
layout: post
title: rtp timestamp
date: 2023-10-08 12:10:00 +0800
author: Fisher
pin: True
meta: Post
categories: webrtc rtp
---


* content
{:toc}

---

## 0. 前言

RTP timestamp是用时钟频率（clock rate）计算而来表示时间的。
RTP timestamp表示每帧的时间，**由于一个帧（如I帧）可能被分成多个RTP包，所以多个相同帧的RTP timestamp相等**。（可以通过每帧最后一个RTP的marker标志区别帧，但最可靠的方法是查看相同RTP timestamp包为同一帧。）

RTP包头的第2个32Bit即为RTP包的时间戳，Time Stamp ，占32位。
时间戳反映了RTP分组中的数据的第一个字节的采样时刻。**在一次会话开始时的时间戳初值也是随机选择的**。即使是没有信号发送时，时间戳的数值也要随时间不断的增加。接收端使用时间戳可准确知道应当在什么时间还原哪一个数据块，从而消除传输中的抖动。时间戳还可用来使视频应用中声音和图像同步。

在RTP协议中并没有规定时间戳的粒度，这取决于有效载荷的类型。因此**RTP的时间戳又称为媒体时间戳**，以强调这种时间戳的粒度取决于信号的类型。例如，对于8kHz采样的话音信号，**若每隔20ms构成一个数据块，则一个数据块中包含有160个样本（0.02×8000=160）。因此每发送一个RTP分组，其时间戳的值就增加160**。
————————————————
原文链接：https://blog.csdn.net/toshiba689/article/details/79428815



> **重点**
>
> **时间戳增加一并不是我们通常意义上的过了一个微秒，而是增加了一个采样间隔那么长的时间**。
>
> 语音包通常是每隔20ms 发一个语音包，对于采样率是48k的音频数据，相当于 ( 20ms / 1000 ) s * 48 000 = 960,。换句话说，1s 采集 48 000，1ms 就是要采集48次，那么 1次采集需要1/48ms， 那么20ms 的采集次数就是1/48 * （48 *20）=  960；



## 1. 概念分析

### 1.1 采样率

采样率就是每秒钟抽取图像或声波幅度样本的次数。比如音频采样率8k，表示1秒有8000次采样,视频很少提及采样率这个概念。 

### 1.2 帧率

帧率就是每秒显示帧数。比如30fps标识1秒显示30帧图像,音频没有帧率但可以算出帧率：采样率/1024。  

### 1.3 !!! 时间戳单位

时间戳计算的单位不为秒之类的单位，而是由采样频率所代替的单位，这样做的目的就是为了是时间戳单位更为精准。比如说**一个音频的采样频率为8000HZ，那么我们可以把时间戳单位设为1/8000， 1次采集需要的时间**。    

### 1.4 !!! 时间戳增量

相邻两个RTP包之间的时间差（以时间戳单位为基准）。  **时间戳增量换个说法，就是两个RTP包之间增加了多少个采集样本**

```bash
时间戳增量 = 两个RTP包时间差（毫秒）* (采样率) / 1000
```

- 两个RTP包时间差（毫秒）， 音频是20ms 发送一次，视频是40ms发送一次（25帧来换算= 1s/25）
- 采样率
- 1000 就是单位换算为ms



## 2. 视频时间戳分析

视频帧率是25(FPS)，采样率是90KHZ(视频很少使用采样率这个概念每秒钟抽取图像样本的次数)。
两视频帧的间隔为：1 秒/ 25帧 = 0.04(帧/秒) = 40(毫帧/秒)， **40ms 采集一帧数据**；
时间戳增量单位：1/90000(秒/个) ，特别注意RTP时间戳是有单位的
每帧对应的采样： 90000 / 25 = 3600 (个/帧)

对应关系如下：

| 时间     | 符号 | 采集样本个数 |
| -------- | ---- | ------------ |
| 1(秒)    | 等于 | 90000(个)    |
| 40(毫秒) | 等于 | 3600(个)     |
| 1(毫秒)  | 等于 | 90(个)       |

视频时间戳计算公式：时间戳增量 = 两个RTP包时间差（毫秒）* 90000(采样率) / 1000
带入公式，每40ms 采集一帧 * 90000/1000 = 3600 采集样本

> 1. 采样率和帧率不是相等的概念
> 2. 一帧应该是对应多少次的采集；比如视频25帧，采样率是90KHZ，那么1帧就3600次的采集(90000 / 25 = 3600 (个/帧))

### !!! 相邻帧间RTP timestamp增量值

两帧之间RTP timestamp的增量 = 时钟频率 / 帧率。
前一帧的timestamp加上固定的timestamp的增量就是下一帧。**时间戳增量换个说法，就是两个RTP包之间增加了多少个采集样本**

举例：
其中时钟频率可从SDP中获取，如:

```js
m=video 2834 RTP/AVP 96
a=rtpmap:96 H264/90000
```

其时钟频率为90000（通常视频的时钟频率），若视频帧率为25fps，则相邻帧间RTP timestamp增量值 = 90000/25 = 3600。
原文链接：https://blog.csdn.net/qq_28258885/article/details/119675555



## 3. !!! 音频时间戳分析

采样率是48K为例子，

时间戳增量单位：1/48000(秒/个) ，特别注意RTP时间戳是有单位的

对应关系如下：

| 时间     | 符号 | 采集样本个数 |
| -------- | ---- | ------------ |
| 1(秒)    | 等于 | 48000(个)    |
| 20(毫秒) | 等于 | 960（个）    |
| 1(毫秒)  | 等于 | 48(个)       |

**音频时间戳计算公式：时间戳增量 = 两个RTP包时间差（毫秒）* 48000(采样率) / 1000（ms转换为s）**

![rtp_audio_timestamp](../assets/ntp/rtp_audio_timestamp.webp)

音频时间戳的单位就是采样率的倒数，例如采样率48000，那么1秒就有48000个采样，每个采样1/48ms，每个采样对应一个时间戳。**RTP音频包一般打包20ms的数据**，**对应的采样数为 48000 * 20 / 1000 = 960**，**也就是说每个音频包里携带960个音频采样，因为1个采样对应1个时间戳，那么相邻两个音频RTP包的时间戳之差就是960。**

参考：[2.2 音频时间戳](https://zhuanlan.zhihu.com/p/592278875?utm_id=0)

## 4. 时间戳增量伪代码

```cpp
//视频时间戳增量
private uint GetVideoTimestamp(MediaFrame mediaFrame)
{
    if (视频时间戳== 0)
    {
        视频时间戳 = mediaFrame.采集时间戳;
        return 0;
    }
    else
    {
        var step = mediaFrame.采集时间戳 - 视频时间戳;
        视频时间戳 =  mediaFrame.采集时间戳;
        return step * 90000 / 1000;
     }
}
 
//音频时间戳增量
private uint GetAudioTimestamp(MediaFrame mediaFrame)
{
    if (音频时间戳== 0)
    {
        _timestampAudio = mediaFrame.采集时间戳;
        return 0;
    }
    else
    {
        var step = mediaFrame.采集时间戳 - 音频时间戳;
        音频时间戳 =  mediaFrame.采集时间戳;
        return step * 采样率 / 1000;  //采样率可以从ADTS Header中算出来
     }
}
```





## 5. 关于时间戳总结

关于时间戳，归纳为以下几个重要的点：

- 时间戳就是一个值，用来反映某个数据块的产生（采集）时间点的，后采集的数据块的时间戳一般大于先采集的数据块的。为什么说一般呢？**因为时间戳是一个32位无符号整型，如果一直递增到了一定时间数值就会回滚，所以时间戳只是对数据块先后顺序的一个参考。**
- 在实时流传输中，数据采集后立刻传递到RTP模块进行发送，那么，其实，数据块的采集时间戳就直接作为RTP包的时间戳（要转换为某个时钟频率）。
- 如果用RTP来传输固定的文件，则这个时间戳就是视频文件中每一帧携带的时间戳，但是也需要转换为对应RTP通道的时钟频率。
- 时间戳的单位采用的是采样频率的倒数，例如采样频率为8000Hz时，时间戳的单位为1 / 8000 ，在Jrtplib库中，有设置时间戳单位的函数接口，而ORTP库中根据负载类型直接给定了时间戳的单位（音频负载1/8000，视频负载1/90000）
- 时间戳增量是指相邻两帧（不一定是相邻两个RTP包）之间的时间间隔。如果采样频率为90000Hz，则由上面讨论可知，时间戳单位为1/90000，我们就假设1s钟被划分了90000个时间块，那么，如果每秒发送25帧，那么，每一个帧的发送占多少个时间块呢？当然是 90000/25 = 3600。因此，我们根据定义“时间戳增量是发送第二个RTP包相距发送第一个RTP包时的时间间隔”，故时间戳增量应该为3600。



## 参考

[RTP中timestamp与帧率及时钟频率的关系](https://blog.csdn.net/qq_28258885/article/details/119675555)

https://blog.csdn.net/toshiba689/article/details/79428815
