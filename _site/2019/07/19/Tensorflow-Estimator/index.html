<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Tensorflow Estimator 详解</title>
    <meta name="description" content="">

    <!-- 网站所有权验证 -->
    <meta name="baidu-site-verification" content="code-kzX4R1yDEi" />
    <meta name="google-site-verification" content="kj0sMKl0iZFsV2KPqmN9OJ3S7aeCrJnNYAOTpJzXCz4" />
    <meta name="msvalidate.01" content="C9A829578EE81A43ECA102B601A5E052" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/css/zui.min.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2019/07/19/Tensorflow-Estimator/">
    <link rel="alternate" type="application/rss+xml" title="Jarvis' Blog (总有美丽的风景让人流连)" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b9d127980a49e998bbedb8aab536a81d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-108096001-2', 'auto');
      ga('send', 'pageview');

    </script>





<!--  -->
    
<script type="text/javascript">
    var host = "jarvis73.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
      window.location.protocol = "https";
</script>
</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/index.html" class="brand">Jarvis' Blog (总有美丽的风景让人流连)</a>
        <small>总有美丽的风景让人流连</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/index.html">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/wiki/">
                        
                            <i class="fa fa-book"></i>Wiki
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left-jekyll">
        <h1>Tensorflow Estimator 详解</h1>
        <div class="label-custom">

            <div class="label-custom-card">
                <i class="fa fa-calendar"></i>2019-07-19
            </div>

            

            <div class="label-custom-card">
                <i class="fa fa-user"></i>Jarvis
                
            </div>

            <div class="label-custom-card">
                <i class="fa fa-key"></i>Post  
            </div>

            <div class="label-custom-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Framework" title="Category: Framework" rel="category">Framework</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#1-estimator-基本结构" id="markdown-toc-1-estimator-基本结构">1. Estimator 基本结构</a>    <ul>
      <li><a href="#11-预创建的-estimator" id="markdown-toc-11-预创建的-estimator">1.1 预创建的 Estimator</a></li>
      <li><a href="#12-自定义的-estimator" id="markdown-toc-12-自定义的-estimator">1.2 自定义的 Estimator</a></li>
      <li><a href="#13-模型函数" id="markdown-toc-13-模型函数">1.3 模型函数</a></li>
      <li><a href="#14-数据输入函数" id="markdown-toc-14-数据输入函数">1.4 数据输入函数</a></li>
      <li><a href="#15-estimator-参数" id="markdown-toc-15-estimator-参数">1.5 Estimator 参数</a>        <ul>
          <li><a href="#151-config-参数" id="markdown-toc-151-config-参数">1.5.1 <code class="language-plaintext highlighter-rouge">config</code> 参数</a></li>
          <li><a href="#152-params-参数" id="markdown-toc-152-params-参数">1.5.2 <code class="language-plaintext highlighter-rouge">params</code> 参数</a></li>
          <li><a href="#153-warm_start_from-参数" id="markdown-toc-153-warm_start_from-参数">1.5.3 <code class="language-plaintext highlighter-rouge">warm_start_from</code> 参数</a></li>
        </ul>
      </li>
      <li><a href="#16-钩子" id="markdown-toc-16-钩子">1.6 钩子</a></li>
    </ul>
  </li>
</ul>

<p>Tensorflow 中目前主推的科研向API为 <code class="language-plaintext highlighter-rouge">tf.keras</code>, 而另一个封装性更高的高阶API <code class="language-plaintext highlighter-rouge">Estimator</code> 集成了常用的深度学习模型的操作:</p>

<ul>
  <li>训练</li>
  <li>评估</li>
  <li>预测</li>
  <li>导出以供使用</li>
</ul>

<p>由于 Estimator 的封装性太高, 导致定制性较差. 因此本文的目的是解剖 Estimator 的内部结构, 从而可以让我们在需要时既能使用到 Estimator 的简化性和分布式训练等功能, 也能随心所欲的添加我们额外需要的功能(通过仿照源码重写 <code class="language-plaintext highlighter-rouge">Estimator</code> 类, 本文写作时使用的 <code class="language-plaintext highlighter-rouge">Tensorflow</code> 版本为 1.13, 此版本中 <code class="language-plaintext highlighter-rouge">Estimator</code> 类不允许继承, 因此我们要添加复杂的功能只能重写, 这部分会在后面讲到).</p>

<div class="polaroid">
    
    
    
    <img data-toggle="lightbox" src="/images/2019/07/tf_programming.png" data-caption="Tensorflow 多级API编程堆栈" />
    
        
        <div class="container">
            <p>图 1. Tensorflow 多级API编程堆栈</p>
        </div>
    
</div>

<h2 id="1-estimator-基本结构">1. Estimator 基本结构</h2>

<p>Estimator 本质上就是一个管理员, 他同时负责了模型的训练, 评估, 预测和导出.</p>

<h3 id="11-预创建的-estimator">1.1 预创建的 Estimator</h3>

<p>Tensorflow 官方提供了一些简单的预创建 Estimator 以供直接使用:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.BaselineClassifier</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.BaselineRegressor</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.DNNLinearCombinedClassifier</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.DNNLinearCombinedRegressor</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.LinearClassifier</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.LinearRegressor</code></li>
</ul>

<p>但是这类 Estimator 的功能太简单, 难以拓展, 因此常用的是自定义的 Estimator.</p>

<h3 id="12-自定义的-estimator">1.2 自定义的 Estimator</h3>

<p>Estimator 类创建的签名如下:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">EstimatorV2</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="n">model_fn</span><span class="p">,</span>
                 <span class="n">model_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">warm_start_from</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用 Estimator 训练/验证/预测模型的代码如下:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1"># 创建 Estimator
</span><span class="n">esti</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="nc">Estimator</span><span class="p">(</span><span class="n">model_fn</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="c1"># 训练
</span><span class="n">esti</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span><span class="n">input_fn</span><span class="p">,</span> <span class="n">hooks</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">saving_listeners</span><span class="p">)</span>
<span class="c1"># 验证
</span><span class="n">esti</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">(</span><span class="n">input_fn</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">hooks</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="c1"># 预测
</span><span class="n">esti</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">input_fn</span><span class="p">,</span> <span class="n">predict_keys</span><span class="p">,</span> <span class="n">hooks</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">yield_single_examples</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>创建自定义的 Estimator 需要编程人员编写以下几部分:</p>

<ol>
  <li>模型函数 <code class="language-plaintext highlighter-rouge">model_fn</code></li>
  <li>数据输入函数 <code class="language-plaintext highlighter-rouge">input_fn</code></li>
  <li>定义所有传入 Estimator 的参数: <code class="language-plaintext highlighter-rouge">config</code>, <code class="language-plaintext highlighter-rouge">params</code> 及其他参数</li>
  <li>钩子 <code class="language-plaintext highlighter-rouge">hooks</code></li>
</ol>

<h3 id="13-模型函数">1.3 模型函数</h3>

<p><strong>函数参数.</strong> 模型函数应当是一个可以调用的函数, 其函数签名如下:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">model_fn</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">mode</code>, <code class="language-plaintext highlighter-rouge">params</code>, <code class="language-plaintext highlighter-rouge">config</code> 参数是可选的, 即自定义 <code class="language-plaintext highlighter-rouge">model_fn</code> 时这三个参数可以不使用, 比如可以定义成</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">model_fn</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">features</code> 和 <code class="language-plaintext highlighter-rouge">labels</code> 是数据输入函数 <code class="language-plaintext highlighter-rouge">input_fn</code> 返回的两个对象, 通常表示数据特征和对应的标签. <code class="language-plaintext highlighter-rouge">features</code> 和 <code class="language-plaintext highlighter-rouge">labels</code> 既可以是 Tensor, 也可以是 Python 字典, 其值为 Tensor, 因此这两个参数可以通过字典传递任何数据(一批)到模型中使用.</p>

<p>Estimator 的训练流程(<code class="language-plaintext highlighter-rouge">session.run()</code>)是封装在类内部的, 同时没有提供 <code class="language-plaintext highlighter-rouge">feed_dict</code> 的参数结构, 因此我们不能像 Tensorflow 低阶API中那样使用 <code class="language-plaintext highlighter-rouge">placeholder</code> 馈送数据到模型中. 官方建议的方式是用 <code class="language-plaintext highlighter-rouge">tf.data.Dataset</code> 类创建数据输入管线, 其用法也相当灵活, 可以参考 <a href="https://www.jarvis73.com/2018/04/28/Tensorflow-Input-Pipline/">Tensorflow 数据输入管线</a>, 这里就不再赘述. 其最终目标就是数据输入函数 <code class="language-plaintext highlighter-rouge">input_fn</code> 返回的必须是 <code class="language-plaintext highlighter-rouge">tf.Tensor</code> 或其嵌套(nested)对象, 从而 <code class="language-plaintext highlighter-rouge">model_fn</code> 接收到的也是 Tensor.</p>

<p><strong>函数体.</strong> 接下来就只需要在 <code class="language-plaintext highlighter-rouge">model_fn</code> 内部写入创建模型的代码, 可以使用 <code class="language-plaintext highlighter-rouge">tf.layers</code> API(在2.0版本中被移除了)或 <code class="language-plaintext highlighter-rouge">tf.contrib.slim</code> API(也在2.0版本中被移除了)或低阶API(<code class="language-plaintext highlighter-rouge">tf.Variable</code> + <code class="language-plaintext highlighter-rouge">tf.nn</code>).</p>

<p>函数体内需要使用 <code class="language-plaintext highlighter-rouge">mode</code> 参数来对训练/验证/预测定义不同的代码. <code class="language-plaintext highlighter-rouge">mode</code> 的取值为:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.ModeKeys.TRAIN</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.ModeKeys.EVAL</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.estimator.ModeKeys.PREDICT</code></li>
</ul>

<p>分别对应了训练/验证/预测模式.</p>

<p><strong>函数返回.</strong> 模型函数应当返回一个 <code class="language-plaintext highlighter-rouge">tf.estimator.EstimatorSpec</code> 对象. EstimatorSpec 是一个很简单的类, 作用仅仅是保存模型函数输出对象(如模式, 训练操作, 损失, 要预测的Tensor, 评估指标, 钩子等). 该类的签名为:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">EstimatorSpec</span><span class="p">(</span>
    <span class="n">collections</span><span class="p">.</span><span class="nf">namedtuple</span><span class="p">(</span><span class="sh">'</span><span class="s">EstimatorSpec</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span>
        <span class="sh">'</span><span class="s">mode</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">predictions</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">loss</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">train_op</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">eval_metric_ops</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">export_outputs</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">training_chief_hooks</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">training_hooks</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">scaffold</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">evaluation_hooks</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">prediction_hooks</span><span class="sh">'</span>
    <span class="p">])):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span>
                <span class="n">mode</span><span class="p">,</span>
                <span class="n">predictions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">loss</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">train_op</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">eval_metric_ops</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">export_outputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">training_chief_hooks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">training_hooks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">scaffold</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">evaluation_hooks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">prediction_hooks</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>一般来说, 在不同的模式下, 需要返回不同的 EstimatorSpec:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>
<span class="c1"># Construct networks...
</span>
<span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">ModeKeys</span><span class="p">.</span><span class="n">TRAIN</span><span class="p">:</span>
    <span class="c1"># ...code...
</span>    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="nc">EstimatorSpec</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">train_op</span><span class="o">=</span><span class="n">train_op</span><span class="p">)</span>

<span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">ModeKeys</span><span class="p">.</span><span class="n">EVAL</span><span class="p">:</span>
    <span class="c1"># ...code...
</span>    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">accuracy</span><span class="sh">'</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">}</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">summary</span><span class="p">.</span><span class="nf">scalar</span><span class="p">(</span><span class="sh">'</span><span class="s">accuracy</span><span class="sh">'</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="nc">EstimatorSpec</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">eval_metric_ops</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>

<span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">ModeKeys</span><span class="p">.</span><span class="n">PREDICT</span><span class="p">:</span>
    <span class="c1"># ...code...
</span>    <span class="n">predicted_classes</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">class_ids</span><span class="sh">'</span><span class="p">:</span> <span class="n">predicted_classes</span><span class="p">[:,</span> <span class="n">tf</span><span class="p">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="sh">'</span><span class="s">probabilities</span><span class="sh">'</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nf">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">logits</span><span class="sh">'</span><span class="p">:</span> <span class="n">logits</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="nc">EstimatorSpec</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="14-数据输入函数">1.4 数据输入函数</h3>

<p><strong>函数参数.</strong> 数据输入函数不需要固定格式, 但是如果有 <code class="language-plaintext highlighter-rouge">mode</code>, <code class="language-plaintext highlighter-rouge">params</code>, <code class="language-plaintext highlighter-rouge">config</code>参数的话, Estimator 会把自身的这三个参数传入 <code class="language-plaintext highlighter-rouge">input_fn</code>, 函数签名如下:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1"># 仅从 Estimator 传入 mode 参数
</span><span class="k">def</span> <span class="nf">input_fn</span><span class="p">(</span><span class="n">args1</span><span class="p">,</span> <span class="n">args2</span><span class="p">,</span> <span class="n">kwargs1</span><span class="p">,</span> <span class="n">kwargs2</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># 从 Estimator 传入 mode, params 和 config 参数
</span><span class="k">def</span> <span class="nf">input_fn</span><span class="p">(</span><span class="n">args1</span><span class="p">,</span> <span class="n">args2</span><span class="p">,</span> <span class="n">kwargs1</span><span class="p">,</span> <span class="n">kwargs2</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>通常使用 <code class="language-plaintext highlighter-rouge">mode</code> 参数的话方便统一使用 <code class="language-plaintext highlighter-rouge">input_fn</code> 同时定义训练/验证/预测模式下的数据加载器(data loader). 上面已经说过了, <code class="language-plaintext highlighter-rouge">input_fn</code> 需要返回 Tensor 或者嵌套的 Tensor.</p>

<p><strong>函数体.</strong> 建议使用 <code class="language-plaintext highlighter-rouge">tf.data.Dataset</code> 构造数据集.</p>

<p><strong>函数返回.</strong> 需要注意的是 <code class="language-plaintext highlighter-rouge">input_fn</code> 返回的应当是 <code class="language-plaintext highlighter-rouge">tf.data.Dataset</code> 的实例, 不需要调用 <code class="language-plaintext highlighter-rouge">make_initialiable_iterator()</code> 和 <code class="language-plaintext highlighter-rouge">get_next()</code> 函数. Estimator 会负责从 <code class="language-plaintext highlighter-rouge">Dataset</code> 创建迭代器并获取下一批数据并送入 <code class="language-plaintext highlighter-rouge">model_fn</code>. 下面解析 Estimator 源码时会看到内部创建迭代器的过程.</p>

<h3 id="15-estimator-参数">1.5 Estimator 参数</h3>

<p>Estimator 中关键的参数主要是 <code class="language-plaintext highlighter-rouge">params</code> 和 <code class="language-plaintext highlighter-rouge">config</code>.</p>

<h4 id="151-config-参数">1.5.1 <code class="language-plaintext highlighter-rouge">config</code> 参数</h4>

<p><code class="language-plaintext highlighter-rouge">config</code> 参数是一个 <code class="language-plaintext highlighter-rouge">tf.estimator.RunConfig</code> 实例, 包含了配置设备, 训练流程控制, 分布式等参数. 类的签名如下:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">RunConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">This class specifies the configurations for an `Estimator` run.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="n">model_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">tf_random_seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">save_summary_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                 <span class="n">save_checkpoints_steps</span><span class="o">=</span><span class="n">_USE_DEFAULT</span><span class="p">,</span>
                 <span class="n">save_checkpoints_secs</span><span class="o">=</span><span class="n">_USE_DEFAULT</span><span class="p">,</span>
                 <span class="n">session_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">keep_checkpoint_every_n_hours</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="n">log_step_count_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                 <span class="n">train_distribute</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">device_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">protocol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">eval_distribute</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">experimental_distribute</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">experimental_max_worker_delay_secs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>下面对一些参数做简要的解释:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">model_dir</code> 参数和 Estimator 中的同名参数相同, 两种方式都可以提供, 同时提供必须保证相同. 该参数指定了summary和模型保存的文件夹.</li>
  <li><code class="language-plaintext highlighter-rouge">session_config</code> 是一个 <code class="language-plaintext highlighter-rouge">tf.ConfigProto</code>实例, 用于提供硬件设备配置, 如显存使用率, 显存是否按需增长, 是否允许变量所在设备的妥协(没有GPU时放在CPU上), CPU的使用数量, 操作内并行和操作间并行的线程数量等等.</li>
  <li><code class="language-plaintext highlighter-rouge">train_distribute</code> 用来指定分布式训练策略, 如 <code class="language-plaintext highlighter-rouge">tf.distribute.MirroredStrategy</code>.</li>
</ul>

<h4 id="152-params-参数">1.5.2 <code class="language-plaintext highlighter-rouge">params</code> 参数</h4>

<p><code class="language-plaintext highlighter-rouge">params</code> 参数就是一个Python字典, 可以传入任何用户定义的参数, 从上面的讨论我们知道该参数可以传递到 <code class="language-plaintext highlighter-rouge">model_fn</code> 和 <code class="language-plaintext highlighter-rouge">input_fn</code>, 为用户参数传递提供了方便.</p>

<h4 id="153-warm_start_from-参数">1.5.3 <code class="language-plaintext highlighter-rouge">warm_start_from</code> 参数</h4>

<p>这是一个可选参数, 用于在开始训练之前载入热身参数(如可以避免模型冷启动导致的loss突变).</p>

<ul>
  <li>该参数可以传入一个Tensorflow检查点, 此时会把计算图中所有的可训练参数从检查点中初始化.</li>
  <li>该参数也可以传入一个 <code class="language-plaintext highlighter-rouge">tf.estimator.WarmStartSettings</code> 的实例, 该类也是一个属性类, 提供了参数可以指定需要从检查点初始化的变量, 从而避免初始化所有变量.</li>
</ul>

<p>Estimator 是使用 <code class="language-plaintext highlighter-rouge">tf.train.init_from_checkpoint()</code> 载入检查点的.</p>

<h3 id="16-钩子">1.6 钩子</h3>

<p>(未完待续)</p>

        </article>
        <hr>

        <!-- 
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
         -->

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2019/06/24/Optimizers-in-Machine-Learning/">机器学习中的优化器(Optimizers in Machine Learning)</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2019/07/29/GLCM/">灰度共生矩阵(Grey Level Co-occurrence Matrix, GLCM)</a></p>
        
    </div>
</div>


        <!-- <h2 id="comments">Comments</h2>
        



 -->


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right-jekyll">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id]):not([class])')
    for (var i = 0; i < aTags.length; i++) {
        if (aTags[i].getAttribute('href').startsWith('#'))
        {
            continue
        }
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>

    <footer class="site-footer">


    <div class="wrapper">

        <p class="contact">
            联系我: 
            <a href="https://github.com/jarvis73" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:zjw.math@qq.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>   
            <a href="https://www.zhihu.com/people/lin-xi-1-1" title="Zhihu"><i class="iconfont icon-daoruzhihu"></i></a>      
        </p>
        <p>
            <i class="fa fa-eye" style="padding-right: 2px;"></i> 访问量: <span id="busuanzi_value_site_pv"></span>次 | <i class="fa fa-user" style="padding-right: 2px;"></i> 访客数<span id="busuanzi_value_site_uv"></span>人次
        </p>
        <p class="power">
            网站支持 <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a> | 主题支持 <a href="https://github.com/Gaohaoyang/gaohaoyang.github.io">HyG</a> & <a href="https://github.com/Jarvis73/jarvis73.github.io">Jarvis73</a>
        </p>
        <p>
            <img src="/images/misc/beian.png" style="padding-right: 2px; padding-bottom: 4px; vertical-align: middle;" /> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo" class="beian" >浙公网安备 33010602011353号 | </a>
            <a target="_blank" href="https://beian.miit.gov.cn/" class="beian">浙ICP备2020038513号-1</a>
        </p>
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/lib/jquery/jquery.js" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/js/zui.min.js" charset="utf-8"></script>
    <script src="/js/index_page.js" charset="utf-8"></script>
    <script src="/js/functions.js" charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
  </body>

</html>
