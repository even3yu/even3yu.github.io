<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>SSH 工具教程 (Tutorial of SSH tools)</title>
    <meta name="description" content="ssh 是远程连接的利器, 可以说凡是涉及到 linux 服务器, ssh 就是一个绕不开的话题. 本文作为一个教程, 尽可能详细的帮助读者设置 ssh, 并给出一些常用的 ssh 配置方法 (主要用于 linux 系统的远程登录和文件传输).">

    <!-- 网站所有权验证 -->
    <meta name="baidu-site-verification" content="code-kzX4R1yDEi" />
    <meta name="google-site-verification" content="kj0sMKl0iZFsV2KPqmN9OJ3S7aeCrJnNYAOTpJzXCz4" />
    <meta name="msvalidate.01" content="C9A829578EE81A43ECA102B601A5E052" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/css/zui.min.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2022/09/17/SSH-Keygen/">
    <link rel="alternate" type="application/rss+xml" title="Jarvis' Blog (总有美丽的风景让人流连)" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b9d127980a49e998bbedb8aab536a81d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-108096001-2', 'auto');
      ga('send', 'pageview');

    </script>





<!--  -->
    
<script type="text/javascript">
    var host = "jarvis73.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
      window.location.protocol = "https";
</script>
</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/index.html" class="brand">Jarvis' Blog (总有美丽的风景让人流连)</a>
        <small>总有美丽的风景让人流连</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/index.html">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/wiki/">
                        
                            <i class="fa fa-book"></i>Wiki
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left-jekyll">
        <h1>SSH 工具教程 (Tutorial of SSH tools)</h1>
        <div class="label-custom">

            <div class="label-custom-card">
                <i class="fa fa-calendar"></i>2022-09-17
            </div>

            

            <div class="label-custom-card">
                <i class="fa fa-user"></i>Jarvis
                
            </div>

            <div class="label-custom-card">
                <i class="fa fa-key"></i>Post  
            </div>

            <div class="label-custom-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Tools" title="Category: Tools" rel="category">Tools</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#1-简介" id="markdown-toc-1-简介">1. 简介</a></li>
  <li><a href="#2-使用方法" id="markdown-toc-2-使用方法">2. 使用方法</a>    <ul>
      <li><a href="#21-密码登录" id="markdown-toc-21-密码登录">2.1 密码登录</a></li>
      <li><a href="#22-密钥登录-免密登录" id="markdown-toc-22-密钥登录-免密登录">2.2 密钥登录 (免密登录)</a></li>
      <li><a href="#23-使用配置文件" id="markdown-toc-23-使用配置文件">2.3 使用配置文件</a></li>
      <li><a href="#24-其他用法" id="markdown-toc-24-其他用法">2.4 其他用法</a></li>
    </ul>
  </li>
  <li><a href="#3-ssh-隧道-端口转发" id="markdown-toc-3-ssh-隧道-端口转发">3. ssh 隧道, 端口转发</a>    <ul>
      <li><a href="#31-本地转发" id="markdown-toc-31-本地转发">3.1 本地转发</a>        <ul>
          <li><a href="#311-开启隧道" id="markdown-toc-311-开启隧道">3.1.1 开启隧道</a></li>
          <li><a href="#312-从-host2-访问" id="markdown-toc-312-从-host2-访问">3.1.2 从 host2 访问</a></li>
          <li><a href="#313-从-host1-访问" id="markdown-toc-313-从-host1-访问">3.1.3 从 host1 访问</a></li>
          <li><a href="#314-ssh-跳板" id="markdown-toc-314-ssh-跳板">3.1.4 ssh 跳板</a></li>
        </ul>
      </li>
      <li><a href="#32-远程转发" id="markdown-toc-32-远程转发">3.2 远程转发</a>        <ul>
          <li><a href="#321-开启隧道" id="markdown-toc-321-开启隧道">3.2.1 开启隧道</a></li>
          <li><a href="#322-从-host2-访问" id="markdown-toc-322-从-host2-访问">3.2.2 从 host2 访问</a></li>
          <li><a href="#323-ssh-跳板--从-host1-访问" id="markdown-toc-323-ssh-跳板--从-host1-访问">3.2.3 ssh 跳板 + 从 host1 访问</a></li>
        </ul>
      </li>
      <li><a href="#33-动态端口转发" id="markdown-toc-33-动态端口转发">3.3 动态端口转发</a></li>
    </ul>
  </li>
  <li><a href="#4-其他-ssh-相关命令" id="markdown-toc-4-其他-ssh-相关命令">4. 其他 ssh 相关命令</a></li>
</ul>

<p>ssh 是远程连接的利器, 可以说凡是涉及到 linux 服务器, ssh 就是一个绕不开的话题. 本文作为一个教程, 尽可能详细的帮助读者设置 ssh, 并给出一些常用的 ssh 配置方法 (主要用于 linux 系统的远程登录和文件传输).</p>

<h2 id="1-简介">1. 简介</h2>

<p>ssh 分为两个部分, <code class="language-plaintext highlighter-rouge">sshd</code> 服务端和 <code class="language-plaintext highlighter-rouge">ssh</code> 客户端. <code class="language-plaintext highlighter-rouge">sshd</code> 通常在服务器上已经建好并处于可用状态, 因此本文只讨论 ssh 客户端, 即用户通过 ssh 客户端远程连接到服务器上进行操作.</p>

<p>ssh 是一个多平台软件, 在 Windows/Linux/Mac 上均有相应的程序.</p>

<ul>
  <li>
    <p>Windows 下 (以 Win11 为例), 右键开始菜单, 打开【Windows 终端】(Win10 下是打开 【PowerShell】), 输入 <code class="language-plaintext highlighter-rouge">Get-Command ssh</code> 即可查看到 ssh 的安装路径在什么位置, 比如:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>C:\Windows\System32\OpenSSH\ssh.exe
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>此时输入 <code class="language-plaintext highlighter-rouge">ssh</code> 回车, 如果有如下的返回结果, 则说明 ssh 已经正常安装了.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>$ ssh
usage: ssh [-46AaCfGgKkMNnqsTtVvXxYy] [-B bind_interface]
          [-b bind_address] [-c cipher_spec] [-D [bind_address:]port]
          [-E log_file] [-e escape_char] [-F configfile] [-I pkcs11]
          [-i identity_file] [-J [user@]host[:port]] [-L address]
          [-l login_name] [-m mac_spec] [-O ctl_cmd] [-o option] [-p port]
          [-Q query_option] [-R address] [-S ctl_path] [-W host:port]
          [-w local_tun[:remote_tun]] destination [command]
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>如果找不到 ssh, 则可以从 <a href="https://github.com/PowerShell/Win32-OpenSSH/releases">Github</a> 下载 OpenSSH (选择 <code class="language-plaintext highlighter-rouge">.msi</code> 后缀的), 然后双击安装即可.</p>
  </li>
  <li>
    <p>Linux 下, 通常默认就有 ssh</p>
  </li>
</ul>

<h2 id="2-使用方法">2. 使用方法</h2>

<h3 id="21-密码登录">2.1 密码登录</h3>

<p>执行以下命令, 然后输入密码, 即可通过密码登录到远程服务器.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ssh &lt;用户名&gt;@&lt;服务器地址&gt; <span class="nt">-p</span> &lt;端口&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="alert alert-info with-icon card">

<i class="icon-info-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>提示</strong></div><hr />

<div class="content">
      <p>如果使用默认端口 22, 则 <code class="language-plaintext highlighter-rouge">-p &lt;端口&gt;</code> 可以不写.</p>
    </div>

</div>
</div>

<h3 id="22-密钥登录-免密登录">2.2 密钥登录 (免密登录)</h3>

<p>我们可以通过 <code class="language-plaintext highlighter-rouge">ssh-keygen</code> 来生成密钥对. 密钥对包含公钥和私钥, 创建密钥如下:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Windows</span>
ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 2048 <span class="nt">-f</span> C:<span class="se">\U</span>sers<span class="se">\&lt;</span>用户名&gt;<span class="se">\.</span>ssh<span class="se">\m</span>ykey

<span class="c"># Linux</span>
ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 2048 <span class="nt">-f</span> /home/&lt;用户名&gt;/.ssh/mykey
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="alert alert-info with-icon card">

<i class="icon-info-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>提示</strong></div><hr />

<div class="content">
      <p>要求输入 <code class="language-plaintext highlighter-rouge">passphase</code> 时直接回车, 这样才可以免密登录. 再次回车, 生成结束, 输出的指纹和图可以不管.</p>
    </div>

</div>
</div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-t rsa</code>: 指定密钥类型为 RSA</li>
  <li><code class="language-plaintext highlighter-rouge">-b 2048</code>: 指定密钥的位数为 2048</li>
  <li><code class="language-plaintext highlighter-rouge">-f /home/&lt;用户名&gt;/.ssh/mykey</code>: 指定密钥名称为 <code class="language-plaintext highlighter-rouge">mykey</code> (可以自定义), 放在用户的 <code class="language-plaintext highlighter-rouge">.ssh</code> 目录下.</li>
</ul>

<p>这个命令会生成 <code class="language-plaintext highlighter-rouge">mykey</code> 和 <code class="language-plaintext highlighter-rouge">mykey.pub</code> 两个文本文件. 获取公钥 <code class="language-plaintext highlighter-rouge">mykey.pub</code> 的内容:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Windows</span>
<span class="nb">cat </span>C:<span class="se">\U</span>sers<span class="se">\&lt;</span>用户名&gt;<span class="se">\.</span>ssh<span class="se">\m</span>ykey.pub

<span class="c"># Linux</span>
<span class="nb">cat</span> /home/&lt;用户名&gt;/.ssh/mykey.pub
</pre></td></tr></tbody></table></code></pre></div></div>

<p>复制公钥的内容, 然后通过密码先登录到服务器上, 创建 <code class="language-plaintext highlighter-rouge">~/.ssh</code> 目录, 创建 <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code> 文件(注意文件名拼写, 不可写错), 把复制的内容粘贴到末尾新的一行:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c"># 把公钥放到服务器的 `authorized_keys` 文件的末尾. </span>
<span class="nb">mkdir</span> ~/.ssh
<span class="nb">echo</span> <span class="s2">"&lt;复制的公钥粘贴到这里&gt;"</span> <span class="o">&gt;&gt;</span> ~/.ssh/authorized_keys

<span class="c"># 限制 `.ssh` 和 `authorized_keys` 的访问权限为只能自己访问</span>
<span class="nb">chmod </span>700 ~/.ssh
<span class="nb">chmod </span>600 ~/.ssh/authorized_keys
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接下来退出服务器, 回到本地的终端. 如果本地是 Linux, 则还需要限制私钥的权限为只能自己访问:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">chmod </span>600 ~/.ssh/mykey
</pre></td></tr></tbody></table></code></pre></div></div>

<p>注意以上权限修改是必要的, 否则可能由于安全性低的问题 ssh 拒绝使用密钥.</p>

<p>最后我们可以使用 <code class="language-plaintext highlighter-rouge">-i</code> 选项指定私钥登录服务器, 不再需要输入密码:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ssh &lt;用户名&gt;@&lt;服务器地址&gt; <span class="nt">-p</span> &lt;端口&gt; <span class="nt">-i</span> ~<span class="se">\.</span>ssh<span class="se">\m</span>ykey
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="alert alert-info with-icon card">

<i class="icon-info-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>登录时显示 Permission denied</strong></div><hr />

<div class="content">
      <p>如果确保上面的秘钥和权限配置无误, 仍然显示 <code class="language-plaintext highlighter-rouge">Permission denied (publickey)</code> 的话, 可能是管理员开启了 ssh 登录白名单, 新建的账户不在白名单里所以无法登录. 找管理员编辑 <code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_config</code> 文件, 如果其中的 <code class="language-plaintext highlighter-rouge">AllowUsers</code> 设置是启用的, 则在末尾加上当前用户即可.</p>
    </div>

</div>
</div>

<h3 id="23-使用配置文件">2.3 使用配置文件</h3>

<p>注意到上面登录服务器需要指定一大堆参数. 我们可以使用配置文件来简化登录过程. 在<strong>本地</strong>创建并编辑文件 <code class="language-plaintext highlighter-rouge">~/.ssh/config</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>Host &lt;自定义别名&gt;
    HostName &lt;服务器地址&gt;
    Port &lt;端口&gt;
    User &lt;用户名&gt;
    IdentityFile &lt;私钥路径&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>比如, 一个配置可以是这样的</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>Host lab
    HostName 192.168.1.2
    Port 22
    User jarvis
    IdentityFile ~/.ssh/mykey
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最后, 我们可以直接这样登录服务器:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ssh lab
</pre></td></tr></tbody></table></code></pre></div></div>

<p>非常方便, 也好记. 此外, 如果要配置多台远程服务器, 只需要按照 2.2 再创建一个密钥对, 像 2.3 里那样增加一个块写入配置即可.</p>

<h3 id="24-其他用法">2.4 其他用法</h3>

<ul>
  <li>ssh 的时候如果配置了密钥, 但想强制使用密码登录:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ssh lab <span class="nt">-o</span> <span class="nv">PubkeyAuthentication</span><span class="o">=</span>no
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>曾经 ssh 登陆过某个服务器地址, 后来该地址的服务器重装过系统, 则需要在 <code class="language-plaintext highlighter-rouge">~/.ssh/known_hosts</code> 文件中找到该服务器地址, 并删除整行 (vim 打开的话, dd 命令删除光标所在行), 否则会登陆不上服务器.</li>
</ul>

<h2 id="3-ssh-隧道-端口转发">3. ssh 隧道, 端口转发</h2>

<h3 id="31-本地转发">3.1 本地转发</h3>

<p>用一幅图来说明 ssh 隧道是做什么的.</p>

<div class="polaroid">
    
    
    
    <img data-toggle="lightbox" src="/images/2022/09/ssh.png" data-caption="ssh 隧道本地转发示意图" />
    
        
        <div class="container">
            <p>图 1. ssh 隧道本地转发示意图</p>
        </div>
    
</div>

<p>本地转发的意思是通过 ssh 隧道, 把本地的数据转发到远程端口.</p>

<h4 id="311-开启隧道">3.1.1 开启隧道</h4>

<p>假设你的本地机器是 host2, 可以通过 ssh 访问 host3, 但是无法直接访问 host4 上开在 9000 端口的 http 服务, 而 host3 可以访问 host4, 此时就可以利用 ssh 隧道通过 host3 访问 host4 的服务, 如下:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>

<span class="c"># 本地转发模板</span>
ssh <span class="nt">-L</span> <span class="o">[</span>&lt;本地地址&gt;:]&lt;本地端口&gt;:&lt;目标地址&gt;:&lt;目标端口&gt; host3

<span class="c"># 比如上面的例子, -L 表示本地转发</span>
<span class="c"># 用法 1: 使用回环地址 127.0.0.1 或者 localhost</span>
ssh <span class="nt">-L</span> 127.0.0.1:10001:192.168.1.4:9000 host3
ssh <span class="nt">-L</span> localhost:10001:192.168.1.4:9000 host3

<span class="c"># 用法 2: 省略&lt;本地地址&gt;</span>
ssh <span class="nt">-L</span> 10001:192.168.1.4:9000 host3

<span class="c"># 用法3: 使用本地外部地址</span>
ssh <span class="nt">-L</span> 192.168.1.2:10001:192.168.1.4:9000 host3
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="alert alert-primary with-icon card">

<i class="icon-star"></i>
<div class="zui-card-content notitle">

<div class="content">
      <p>由于 host2 开启的转发端口 10001 是在本地, 因此称为【本地转发】.</p>
    </div>

</div>
</div>

<h4 id="312-从-host2-访问">3.1.2 从 host2 访问</h4>

<p>因为隧道是在 host2 上开的, 所以可以在 host2 本地通过 host3 访问 host4 上的 http 服务, 其中</p>
<ul>
  <li>用法 1 和 2 访问: <code class="language-plaintext highlighter-rouge">http://127.0.0.1:10001</code> 或 <code class="language-plaintext highlighter-rouge">http://localhost:10001</code></li>
  <li>用法 3 访问: <code class="language-plaintext highlighter-rouge">http://192.168.1.2:10001</code></li>
</ul>

<div class="alert alert-info with-icon card">

<i class="icon-info-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>提示</strong></div><hr />

<div class="content">
      <p>上图中, 只有 host2 和 host3 之间的通信是 ssh 加密的.</p>
    </div>

</div>
</div>

<h4 id="313-从-host1-访问">3.1.3 从 host1 访问</h4>

<p>如果需要从 host1 通过 host2 访问 host4 上的服务, 则需要增加 <code class="language-plaintext highlighter-rouge">-g</code> 参数:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
ssh <span class="nt">-g</span> <span class="nt">-L</span> 10001:192.168.1.4:9000 host3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时在 host1 上访问 <code class="language-plaintext highlighter-rouge">http://192.168.1.2:10001</code> 即可.</p>

<h4 id="314-ssh-跳板">3.1.4 ssh 跳板</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
ssh <span class="nt">-g</span> <span class="nt">-L</span> 10022:192.168.1.4:22 host3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>我们把 host2 上的 10022 映射到了 host4 上的 22 端口, 而 22 端口是 ssh 端口, 这意味着 host2 成了外界和 host4 直接的跳板机, 此时我们可以从 host1 或者 host2 上 ssh 连接到 host4:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
ssh jarvis@localhost <span class="nt">-p</span> 10022
<span class="c"># host1</span>
ssh jarvis@192.168.1.2 <span class="nt">-p</span> 10022
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果我们不希望 ssh 登录, 只是建立隧道后进入后台的话, 可以加上 <code class="language-plaintext highlighter-rouge">-f</code> 参数 (fork):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
ssh <span class="nt">-f</span> <span class="nt">-g</span> <span class="nt">-L</span> 10022:192.168.1.4:22 host3 ifconfig
ssh <span class="nt">-f</span> <span class="nt">-N</span> <span class="nt">-g</span> <span class="nt">-L</span> 10022:192.168.1.4:22 host3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>注意我们额外加了 <code class="language-plaintext highlighter-rouge">-N</code> 参数, 否则必须指定一个要执行的远程命令</p>

<h3 id="32-远程转发">3.2 远程转发</h3>

<p>假如我们有这样的场景, host3 和 host4 都在内网, 而 host2 在外网, 我们无法通过 host2 直接访问 host3 和 host4, 但是从 host3 可以访问 host2.</p>

<div class="polaroid">
    
    
    
    <img data-toggle="lightbox" src="/images/2022/09/ssh_remote.png" data-caption="ssh 隧道远程转发示意图" />
    
        
        <div class="container">
            <p>图 2. ssh 隧道远程转发示意图</p>
        </div>
    
</div>

<p>远程转发的意思是通过 ssh 隧道, 把远程端口的数据转发到本地.</p>

<h4 id="321-开启隧道">3.2.1 开启隧道</h4>

<p>远程转发需要在 host3 上开启隧道:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># host3</span>
ssh <span class="nt">-R</span> <span class="o">[</span>&lt;远程地址&gt;:]远程端口:&lt;目标地址&gt;:&lt;目标端口&gt; host1

<span class="c"># 举例</span>
ssh <span class="nt">-R</span> 10001:192.168.1.4:9000 host2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这样就在 host2 上的 10001 端口建立了 ssh 隧道连接. 当有主机连接 <code class="language-plaintext highlighter-rouge">host2:10001</code> 时, 流量就会被通过 ssh 隧道转发到 host3, 然后再有 host3 转发给 host4. 由于 host3 发起的转发端口在 host2 上(对于 host3 来说是远程), 因此成为远程端口转发.</p>

<h4 id="322-从-host2-访问">3.2.2 从 host2 访问</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
ssh jarvis@localhost <span class="nt">-p</span> 10001

<span class="c"># host2 (这个连不上)</span>
ssh jarvis@10.76.1.101 <span class="nt">-p</span> 10001
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="alert alert-warning with-icon card">

<i class="icon-warning-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>警告</strong></div><hr />

<div class="content">
      <p>【远程端口】10001 是由 host2 上的 sshd 服务控制的, 因此即使指定了【远程地址】, host2 上的 sshd 也只会把 10001 绑定在回环地址 127.0.0.1 (localhost) 上.</p>
    </div>

</div>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
<span class="c"># 查看端口绑定</span>
netstat <span class="nt">-tnlp</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="323-ssh-跳板--从-host1-访问">3.2.3 ssh 跳板 + 从 host1 访问</h4>

<p>为了能从 host1 和 host2 上通过 10.76.1.101 访问, 需要在 host2 的 sshd 配置文件中, 把 <code class="language-plaintext highlighter-rouge">GatewayPorts=no</code> 改为 <code class="language-plaintext highlighter-rouge">GatewayPorts=yes</code>. 启用该项之后, 无论【远程地址】设置为什么都会绑定在所有地址 (0.0.0.0) 上.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
ssh <span class="nt">-g</span> <span class="nt">-R</span> <span class="k">*</span>:10001:192.168.1.4:9000 host2
ssh <span class="nt">-g</span> <span class="nt">-R</span> 10001:192.168.1.4:9000 host2

<span class="c"># 类似 3.2 中的, 也可以加 -f -N 参数, 参数可缩写</span>
ssh <span class="nt">-fgNR</span> 10001:192.168.1.4:9000 host2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后在 host1 上访问</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># host1</span>
ssh jarvis@10.76.1.101 <span class="nt">-p</span> 10001
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="33-动态端口转发">3.3 动态端口转发</h3>

<p>前面的两种端口转发无论是本地转发还是远程转发, 都只能进行一对一的端口转发, 这意味着同一个端口只能解析一种固定的协议. 比如我把本地的 10001 端口转发到远程的 80 端口 (web 服务, http 协议), 那么本地的 10001 端口只能用于 web 服务的访问, 不能用于 ssh 连接.</p>

<p>ssh 支持动态转发, 由 ssh 判断发起请求的工具使用的是什么协议, 并动态的转发到相应的目标端口.</p>

<div class="polaroid">
    
    
    
    <img data-toggle="lightbox" src="/images/2022/09/ssh_dynamic.png" data-caption="ssh 隧道动态转发示意图" />
    
        
        <div class="container">
            <p>图 3. ssh 隧道动态转发示意图</p>
        </div>
    
</div>

<p>如上图所示, 我们希望从 host2 既能访问互联网, 又能通过 ssh 连接到 host4. 单独开两个端口映射显然是可以的, 但这并不优雅. 这时候我们就可以使用动态转发, 格式如下:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># host2</span>
ssh <span class="nt">-D</span> <span class="o">[</span>&lt;绑定地址&gt;:]端口 host3

<span class="c"># 比如上面的例子</span>
ssh <span class="nt">-fgN</span> <span class="nt">-D</span> 10022 host3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>执行了上面的命令之后, host2 就会在本地开启 SOCKS4 或 SOCKS5 服务来监听 10022 端口. 这时候只要客户端工具将自身的代理设置为 <code class="language-plaintext highlighter-rouge">host2:10022</code>, 则该程序所有的数据就会被经由 <code class="language-plaintext highlighter-rouge">host2:10022</code> 转发给 host3, 然后由 host3 自动根据协议类型决定把数据发往何处.</p>

<p>比如本地使用浏览器代理, 那么浏览器使用的 http/https 流量就会被 host3 转发到互联网上. 如果使用 SecurtCRT 或 putty 等支持代理上网的客户端工具, 则连接 host4 的 ssh 流量也可以通过 host3 被发往 host4.</p>

<h2 id="4-其他-ssh-相关命令">4. 其他 ssh 相关命令</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">scp</code>: 文件复制命令, 通常会随着 ssh 一起安装好.</li>
</ul>

<div class="alert alert-info with-icon card">

<i class="icon-info-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>提示</strong></div><hr />

<div class="content">
      <p><code class="language-plaintext highlighter-rouge">scp</code> 命令也支持 <code class="language-plaintext highlighter-rouge">~/.ssh/config</code> 文件中的配置. <code class="language-plaintext highlighter-rouge">scp</code> 复制命令必须在本地执行.</p>
    </div>

</div>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c"># 本地文件 --&gt; 远程服务器</span>
scp /path/to/source_file lab:~/target_dir

<span class="c"># 本地文件夹 --&gt; 远程服务器</span>
scp <span class="nt">-r</span> /path/to/source_dir lab:~/target_dir

<span class="c"># 远程文件 --&gt; 本地当前目录</span>
scp lab:~/source_file <span class="nb">.</span>

<span class="c"># 远程文件夹 --&gt; 本地当前目录</span>
scp <span class="nt">-r</span> lab:~/source_dir <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sftp</code>: 基于 SSH 加密传输的 FTP 命令行工具, 通常会随着 ssh 一起安装好.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="c"># 登录远程服务器</span>
sftp lab

<span class="c"># 列出服务器文件, 列出本地文件(相当于 local ls)</span>
<span class="nb">ls
</span>lls

<span class="c"># 改变服务器当前目录, 改变本地当前目录 </span>
<span class="nb">cd
</span>lcd

<span class="c"># 本地文件 --&gt; 远程服务器</span>
put source_file

<span class="c"># 本地文件夹 --&gt; 远程服务器</span>
put <span class="nt">-R</span> source_dir

<span class="c"># 远程文件 --&gt; 本地当前目录</span>
get source_file

<span class="c"># 远程文件夹 --&gt; 本地当前目录</span>
get <span class="nt">-R</span> source_dir
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p>SFTP 图形化界面的软件 <a href="https://filezilla-project.org/">FileZilla Client</a> 也比较好用.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ssh-keygen</code>: 生成密钥对, 2.2 节介绍了.</p>
  </li>
</ul>

        </article>
        <hr>

        <!-- 
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
         -->

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2022/09/05/Normal-Distribution/">正态分布的若干结论 (Conclusions of Gaussian distributions)</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2022/11/27/Diffusion-Model-3/">生成扩散模型(三): 灵活性和易处理性 (Generative Diffusion Model: Flexibility and Tractability)</a></p>
        
    </div>
</div>


        <!-- <h2 id="comments">Comments</h2>
        



 -->


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right-jekyll">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id]):not([class])')
    for (var i = 0; i < aTags.length; i++) {
        if (aTags[i].getAttribute('href').startsWith('#'))
        {
            continue
        }
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>

    <footer class="site-footer">


    <div class="wrapper">

        <p class="contact">
            联系我: 
            <a href="https://github.com/jarvis73" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:zjw.math@qq.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>   
            <a href="https://www.zhihu.com/people/lin-xi-1-1" title="Zhihu"><i class="iconfont icon-daoruzhihu"></i></a>      
        </p>
        <p>
            <i class="fa fa-eye" style="padding-right: 2px;"></i> 访问量: <span id="busuanzi_value_site_pv"></span>次 | <i class="fa fa-user" style="padding-right: 2px;"></i> 访客数<span id="busuanzi_value_site_uv"></span>人次
        </p>
        <p class="power">
            网站支持 <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a> | 主题支持 <a href="https://github.com/Gaohaoyang/gaohaoyang.github.io">HyG</a> & <a href="https://github.com/Jarvis73/jarvis73.github.io">Jarvis73</a>
        </p>
        <p>
            <img src="/images/misc/beian.png" style="padding-right: 2px; padding-bottom: 4px; vertical-align: middle;" /> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo" class="beian" >浙公网安备 33010602011353号 | </a>
            <a target="_blank" href="https://beian.miit.gov.cn/" class="beian">浙ICP备2020038513号-1</a>
        </p>
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/lib/jquery/jquery.js" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/js/zui.min.js" charset="utf-8"></script>
    <script src="/js/index_page.js" charset="utf-8"></script>
    <script src="/js/functions.js" charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
  </body>

</html>
