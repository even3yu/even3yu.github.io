<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Tensorflow 自定义数据集 (Tensorflow-Datasets Customization, TFDS)</title>
    <meta name="description" content="">

    <!-- 网站所有权验证 -->
    <meta name="baidu-site-verification" content="code-kzX4R1yDEi" />
    <meta name="google-site-verification" content="kj0sMKl0iZFsV2KPqmN9OJ3S7aeCrJnNYAOTpJzXCz4" />
    <meta name="msvalidate.01" content="C9A829578EE81A43ECA102B601A5E052" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/css/zui.min.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2020/11/25/Tensorflow-Datasets/">
    <link rel="alternate" type="application/rss+xml" title="Jarvis' Blog (总有美丽的风景让人流连)" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b9d127980a49e998bbedb8aab536a81d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-108096001-2', 'auto');
      ga('send', 'pageview');

    </script>





<!--  -->
    
<script type="text/javascript">
    var host = "jarvis73.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
      window.location.protocol = "https";
</script>
</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/index.html" class="brand">Jarvis' Blog (总有美丽的风景让人流连)</a>
        <small>总有美丽的风景让人流连</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/index.html">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/wiki/">
                        
                            <i class="fa fa-book"></i>Wiki
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left-jekyll">
        <h1>Tensorflow 自定义数据集 (Tensorflow-Datasets Customization, TFDS)</h1>
        <div class="label-custom">

            <div class="label-custom-card">
                <i class="fa fa-calendar"></i>2020-11-25
            </div>

            

            <div class="label-custom-card">
                <i class="fa fa-user"></i>Jarvis
                
            </div>

            <div class="label-custom-card">
                <i class="fa fa-key"></i>Post  
            </div>

            <div class="label-custom-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Framework" title="Category: Framework" rel="category">Framework</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#1-安装" id="markdown-toc-1-安装">1. 安装</a>    <ul>
      <li><a href="#11-配置代理" id="markdown-toc-11-配置代理">1.1 配置代理</a></li>
    </ul>
  </li>
  <li><a href="#2-使用内嵌数据-在线下载" id="markdown-toc-2-使用内嵌数据-在线下载">2. 使用内嵌数据 (在线下载)</a></li>
  <li><a href="#3-使用内嵌数据-手动下载" id="markdown-toc-3-使用内嵌数据-手动下载">3. 使用内嵌数据 (手动下载)</a></li>
  <li><a href="#4-使用自定义数据集" id="markdown-toc-4-使用自定义数据集">4. 使用自定义数据集</a>    <ul>
      <li><a href="#41-自定义数据集实例" id="markdown-toc-41-自定义数据集实例">4.1 自定义数据集实例</a></li>
    </ul>
  </li>
</ul>

<p>Tensorflow 提供了一个 <code class="language-plaintext highlighter-rouge">tensorflow-datasets</code> 的 Python 库来方便地下载、加载和管理数据集 (下文把 Tensorflow-Datasets 缩写为 TFDS).</p>

<div class="alert alert-info with-icon card">

<i class="icon-info-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>提示</strong></div><hr />

<div class="content">
      <p>由于在中国大陆范围内谷歌服务不可用, 该 API 在中国大陆需要使用代理来下载数据集.</p>
    </div>

</div>
</div>

<h2 id="1-安装">1. 安装</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>pip <span class="nb">install </span>tensorflow-datasets
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="11-配置代理">1.1 配置代理</h3>

<ul>
  <li>选择任意的代理服务, 假设已经配置了 socks5 代理</li>
  <li>安装 privoxy 之类的工具, 用于把 socks5 转换为 http, https 和 ftp.</li>
  <li>运行任意涉及 <code class="language-plaintext highlighter-rouge">tensorflow_datasets</code> 中 <code class="language-plaintext highlighter-rouge">builder.download_and_prepare()</code> 语句的脚本时, 增加如下的环境变量:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">TFDS_HTTP_PROXY</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">TFDS_HTTPS_PROXY</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">TFDS_FTP_PROXY</span><span class="o">=</span>http://127.0.0.1:8118
</pre></td></tr></tbody></table></code></pre></div></div>

<p>注意以上三个都要添加. 如果是希望仅对当前命令有效, 则可以直接添加到命令开头:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">TFDS_HTTP_PROXY</span><span class="o">=</span>http://127.0.0.1:8118 <span class="nv">TFDS_HTTPS_PROXY</span><span class="o">=</span>http://127.0.0.1:8118 <span class="nv">TFDS_FTP_PROXY</span><span class="o">=</span>http://127.0.0.1:8118 python demo.py
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="2-使用内嵌数据-在线下载">2. 使用内嵌数据 (在线下载)</h2>

<p>TFDS 提供了丰富的内嵌数据集, 包括语音, 图像, 视频, 文本等, 例如知名的 mnist, cifar-10, cifar-100 等等.</p>

<p>对于小型数据集, 我们可以直接使用 API 下载(只会下载一次, 再次调用时会使用缓存的数据集).</p>

<div class="alert alert-info with-icon card">

<i class="icon-info-sign"></i>
<div class="zui-card-content">

<div class="title"><strong>提示</strong></div><hr />

<div class="content">
      <p>在中国大陆的用户可能无法直接从谷歌云存储(Google Cloud Storage, GCS) 下载这些数据集, 需要在运行脚本时按照第1.1节的方法指定代理服务器.</p>
    </div>

</div>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">tensorflow_datasets</span> <span class="k">as</span> <span class="n">tfds</span>

<span class="c1"># 指定要加载的数据集名称, split, 和数据下载解压后存放的位置.
</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">'</span><span class="s">mnist</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">split</span><span class="o">=</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">data_dir</span><span class="o">=</span><span class="sh">'</span><span class="s">/data/tfds</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>当然了也可以使用 <code class="language-plaintext highlighter-rouge">builder</code> API 获取数据集的详细信息:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">builder</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="nf">builder</span><span class="p">(</span><span class="sh">'</span><span class="s">mnist</span><span class="sh">'</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="sh">'</span><span class="s">/data/tfds</span><span class="sh">'</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="nf">download_and_prepare</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">info</span><span class="p">)</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">as_datasets</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>关于内嵌数据更详细的用法, 请参看<a href="https://www.tensorflow.org/datasets">官方文档</a>.</p>

<h2 id="3-使用内嵌数据-手动下载">3. 使用内嵌数据 (手动下载)</h2>

<p>纯手动下载数据并使用 TFDS 加载是无法直接调用 API 做到的, 因为 TFDS 内嵌数据集的下载、解压、生成 TFRecord 是一气呵成的, 没有提供 API 来单独完成某一步. 因此这一节只讨论这几个步骤的结果, 从而我们找到数据后复制到其他设备的相应位置即可.</p>

<p>有些服务器在某些情况下可能无法使用代理, 这时候就需要本地下载好数据集后传到服务器上. 我们先需要对 TFDS 数据集的结构做一个分析. 一个完整的 TFDS 数据集包含以下几部分内容:</p>

<ul>
  <li>数据集名称 dataset_name: 如 cifar10</li>
  <li>版本 version: 如 3.0.2</li>
  <li>数据 data</li>
  <li>数据信息 dataset info: 如 dataset_info.json</li>
  <li>数据特征 dataset features: 如 image.image.json, label.label.json</li>
</ul>

<p>下载的数据 TFDS 会自动进行处理并保存为 TFRecord 格式. 假设我们设置的数据文件夹为 <code class="language-plaintext highlighter-rouge">/data/tfds</code>, 那么</p>

<ul>
  <li>下载的数据保存在: <code class="language-plaintext highlighter-rouge">/data/tfds/downloads</code> (通常是压缩文件)</li>
  <li>解压的数据保存在: <code class="language-plaintext highlighter-rouge">/data/tfds/downloads/extracted</code></li>
  <li>处理过的数据保存在: <code class="language-plaintext highlighter-rouge">/data/tfds/&lt;dataset_name&gt;/&lt;version&gt;</code></li>
</ul>

<p>那么拷贝时我们只需要把处理过的数据(即 TFRecord 数据 + <code class="language-plaintext highlighter-rouge">dataset_info.json</code> + 其他 <code class="language-plaintext highlighter-rouge">*.json</code>)复制到目标设备的数据目录下即可. 然后在使用 TFDS 加载数据时设置不下载数据:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">datasets</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">'</span><span class="s">mnist</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">split</span><span class="o">=</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">data_dir</span><span class="o">=</span><span class="sh">'</span><span class="s">/data/tfds</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">download</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="4-使用自定义数据集">4. 使用自定义数据集</h2>

<p>TFDS 也支持把我们自己的数据集构造为 TFDS 可以读取的格式, 这样就可以使用 TFDS 直接从本地硬盘读取了.</p>

<p>首先根据模板自定义数据集的生成文件:</p>

<ul>
  <li>如果 <code class="language-plaintext highlighter-rouge">tensorflow_datasets &lt;= 3.2.0</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>python /&lt;site-packages&gt;/tensorflow_datasets/scripts/create_new_dataset.py <span class="se">\</span>
  <span class="nt">--dataset</span> &lt;dataset_name&gt; <span class="se">\</span>
  <span class="nt">--type</span> image   <span class="c"># text, audio, translation</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>如果 <code class="language-plaintext highlighter-rouge">tensorflow_datasets &gt;= 4.0.0</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>tfds <span class="nt">--help</span>

tfds new &lt;dataset_name&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后会产生下面的文件(或文件夹), 这个例子是用 <code class="language-plaintext highlighter-rouge">v3.1.0</code> 的版本生成的, <code class="language-plaintext highlighter-rouge">v4.0.0</code> 及以后的版本略有不同, 但可以举一反三.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="sh">"""</span><span class="s">my_dataset dataset.</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">tensorflow_datasets.public_api</span> <span class="k">as</span> <span class="n">tfds</span>

<span class="n">_CITATION</span> <span class="o">=</span> <span class="sh">"""</span><span class="s"> </span><span class="sh">"""</span>

<span class="n">_DESCRIPTION</span> <span class="o">=</span> <span class="sh">"""</span><span class="s"> </span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">(</span><span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">GeneratorBasedBuilder</span><span class="p">):</span>
  <span class="sh">"""</span><span class="s">TODO(my_dataset): Short description of my dataset.</span><span class="sh">"""</span>

  <span class="c1"># TODO(my_dataset): Set up version.
</span>  <span class="n">VERSION</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">Version</span><span class="p">(</span><span class="sh">'</span><span class="s">0.1.0</span><span class="sh">'</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="c1"># TODO(my_dataset): Specifies the tfds.core.DatasetInfo object
</span>    <span class="k">return</span> <span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">DatasetInfo</span><span class="p">(</span>
        <span class="n">builder</span><span class="o">=</span><span class="n">self</span><span class="p">,</span>
        <span class="c1"># This is the description that will appear on the datasets page.
</span>        <span class="n">description</span><span class="o">=</span><span class="n">_DESCRIPTION</span><span class="p">,</span>
        <span class="c1"># tfds.features.FeatureConnectors
</span>        <span class="n">features</span><span class="o">=</span><span class="n">tfds</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="nc">FeaturesDict</span><span class="p">({</span>
            <span class="c1"># These are the features of your dataset like images, labels ...
</span>        <span class="p">}),</span>
        <span class="c1"># If there's a common (input, target) tuple from the features,
</span>        <span class="c1"># specify them here. They'll be used if as_supervised=True in
</span>        <span class="c1"># builder.as_dataset.
</span>        <span class="n">supervised_keys</span><span class="o">=</span><span class="p">(),</span>
        <span class="c1"># Homepage of the dataset for documentation
</span>        <span class="n">homepage</span><span class="o">=</span><span class="sh">'</span><span class="s">https://dataset-homepage/</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">citation</span><span class="o">=</span><span class="n">_CITATION</span><span class="p">,</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_split_generators</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Returns SplitGenerators.</span><span class="sh">"""</span>
    <span class="c1"># TODO(my_dataset): Downloads the data and defines the splits
</span>    <span class="c1"># dl_manager is a tfds.download.DownloadManager that can be used to
</span>    <span class="c1"># download and extract URLs
</span>    <span class="n">path</span> <span class="o">=</span> <span class="n">dl_manager</span><span class="p">.</span><span class="nf">download_and_extract</span><span class="p">(</span><span class="sh">'</span><span class="s">https://todo-data-url</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">SplitGenerator</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">tfds</span><span class="p">.</span><span class="n">Split</span><span class="p">.</span><span class="n">TRAIN</span><span class="p">,</span>
            <span class="c1"># These kwargs will be passed to _generate_examples
</span>           <span class="n">gen_kwargs</span><span class="o">=</span><span class="p">{},</span>
        <span class="p">),</span>
    <span class="p">]</span>

  <span class="k">def</span> <span class="nf">_generate_examples</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Yields examples.</span><span class="sh">"""</span>
    <span class="c1"># TODO(my_dataset): Yields (key, example) tuples from the dataset
</span>    <span class="k">yield</span> <span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中包含三个主要的函数:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_info()</code>: 包含数据集的基本信息和每个数据样本的格式.</li>
  <li><code class="language-plaintext highlighter-rouge">_split_generators()</code>: 数据集的下载和划分.</li>
  <li><code class="language-plaintext highlighter-rouge">_generate_examples()</code>: 每个 split 的生成器, 每次生成一个样本</li>
</ul>

<p>我们要做的就是把这个模板文件按照我们自己的数据集填写完毕. 填写的规则可以参考<a href="https://www.tensorflow.org/datasets/add_dataset">官方文档</a>.</p>

<p>此外, 也可以进一步参考 <code class="language-plaintext highlighter-rouge">/&lt;site-packages&gt;/tensorflow_datasets/image_classification/cifar.py</code> 这类的例子.</p>

<p>这里我们要注意, 要使用本地的数据集, 我们需要把上面代码中下载数据的部分改为直接从本地读取即可:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1"># 把
</span><span class="n">path</span> <span class="o">=</span> <span class="n">dl_manager</span><span class="p">.</span><span class="nf">download_and_extract</span><span class="p">(</span><span class="sh">'</span><span class="s">https://todo-data-url</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># 改为
</span><span class="n">path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/path/to/your_dataset</span><span class="sh">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="41-自定义数据集实例">4.1 自定义数据集实例</h3>

<p>下面给一个读取自定义数据集的一个例子. 该数据集为 PASCAL VOC 2012 数据集, 包含 20 个前景类别, 我们把包含第 1-5 类的图片作为测试数据, 把包含 6-20 类的图片作为训练数据, 打算使用自监督学习训练一个特征提取器. 因此我们需要创建两个只包含图像(不需要标签)的训练集和测试集, 代码如下:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre><span class="sh">"""</span><span class="s">voc_fs dataset.</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">collections</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="n">tensorflow.compat.v1</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="n">tensorflow_datasets.public_api</span> <span class="k">as</span> <span class="n">tfds</span>

<span class="n">_CITATION</span> <span class="o">=</span> <span class="sh">"""</span><span class="s"> </span><span class="sh">"""</span>

<span class="n">_DESCRIPTION</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
PASCAL VOC 2012 datasets for self-supervised learning.
Four splits:
     1 -  5:  aeroplane  bicycle  bird    boat    bootle 
     6 - 10:     bus       car    cat    chair     cow 
    11 - 15: diningtable   dog   horse  motorbike person 
    16 - 20:    plant     sheep   sofa   train     tv
</span><span class="sh">"""</span>


<span class="k">class</span> <span class="nc">VocFS</span><span class="p">(</span><span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">GeneratorBasedBuilder</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> PASCAL VOC 2012 datasets for self-supervised learning  </span><span class="sh">"""</span>

    <span class="n">VERSION</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">Version</span><span class="p">(</span><span class="sh">'</span><span class="s">0.1.0</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">MANUAL_DOWNLOAD_INSTRUCTIONS</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Manually download VOC_FS</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">DatasetInfo</span><span class="p">(</span>
            <span class="n">builder</span><span class="o">=</span><span class="n">self</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">_DESCRIPTION</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">tfds</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="nc">FeaturesDict</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">tfds</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="nc">Text</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">image</span><span class="sh">"</span><span class="p">:</span> <span class="n">tfds</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="nc">Image</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
                                             <span class="n">encoding_format</span><span class="o">=</span><span class="sh">'</span><span class="s">jpeg</span><span class="sh">'</span><span class="p">),</span>
            <span class="p">}),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_split_generators</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Returns SplitGenerators.</span><span class="sh">"""</span>
        <span class="n">voc_fs_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/VOCdevkit/VOC2012</span><span class="sh">"</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">/</span> <span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">VERSION</span><span class="p">)</span>

        <span class="n">train_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">voc_fs_path</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Binary_map_aug/train/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">.txt</span><span class="sh">"</span><span class="p">)</span>\
                <span class="p">.</span><span class="nf">read_text</span><span class="p">().</span><span class="nf">strip</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">voc_fs_path</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">JPEGImages/</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s">.jpg</span><span class="sh">"</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">train_ids</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">train_ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">train_ids</span><span class="p">))</span>
    
        <span class="n">test_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">voc_fs_path</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Binary_map_aug/val/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">.txt</span><span class="sh">"</span><span class="p">)</span>\
                <span class="p">.</span><span class="nf">read_text</span><span class="p">().</span><span class="nf">strip</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">voc_fs_path</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">JPEGImages/</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s">.jpg</span><span class="sh">"</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">test_ids</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">test_ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">test_ids</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">SplitGenerator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="p">{</span> <span class="sh">"</span><span class="s">ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">train_ids</span> <span class="p">}),</span>
            <span class="n">tfds</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="nc">SplitGenerator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="p">{</span> <span class="sh">"</span><span class="s">ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">test_ids</span> <span class="p">}),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_generate_examples</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Yields examples.</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span> 
            <span class="k">yield</span> <span class="n">index</span><span class="p">,</span> <span class="p">{</span> <span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">:</span> <span class="n">id_</span><span class="p">.</span><span class="n">stem</span><span class="p">,</span> <span class="sh">'</span><span class="s">image</span><span class="sh">'</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用 TFDS 加载数据集:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">datasets</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">'</span><span class="s">voc_fs</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">split</span><span class="o">=</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">data_dir</span><span class="o">=</span><span class="sh">'</span><span class="s">/data/tfds</span><span class="sh">'</span><span class="p">,</span> 
                     <span class="n">download</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中第一次加载时 TFDS 会从自动生成 TFRecord 数据集并保存在 <code class="language-plaintext highlighter-rouge">/data/tfds/voc_fs/0.1.0</code> 目录下, 在第二次加载时就会直接读取了.</p>

        </article>
        <hr>

        <!-- 
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
         -->

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2020/11/24/Python-Misc/">Python 相关配置</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2020/12/28/WGAN/">训练 GAN 的理论分析和实践 (Wasserstein GAN)</a></p>
        
    </div>
</div>


        <!-- <h2 id="comments">Comments</h2>
        



 -->


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right-jekyll">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id]):not([class])')
    for (var i = 0; i < aTags.length; i++) {
        if (aTags[i].getAttribute('href').startsWith('#'))
        {
            continue
        }
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>

    <footer class="site-footer">


    <div class="wrapper">

        <p class="contact">
            联系我: 
            <a href="https://github.com/jarvis73" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:zjw.math@qq.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>   
            <a href="https://www.zhihu.com/people/lin-xi-1-1" title="Zhihu"><i class="iconfont icon-daoruzhihu"></i></a>      
        </p>
        <p>
            <i class="fa fa-eye" style="padding-right: 2px;"></i> 访问量: <span id="busuanzi_value_site_pv"></span>次 | <i class="fa fa-user" style="padding-right: 2px;"></i> 访客数<span id="busuanzi_value_site_uv"></span>人次
        </p>
        <p class="power">
            网站支持 <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a> | 主题支持 <a href="https://github.com/Gaohaoyang/gaohaoyang.github.io">HyG</a> & <a href="https://github.com/Jarvis73/jarvis73.github.io">Jarvis73</a>
        </p>
        <p>
            <img src="/images/misc/beian.png" style="padding-right: 2px; padding-bottom: 4px; vertical-align: middle;" /> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo" class="beian" >浙公网安备 33010602011353号 | </a>
            <a target="_blank" href="https://beian.miit.gov.cn/" class="beian">浙ICP备2020038513号-1</a>
        </p>
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/lib/jquery/jquery.js" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/zui/1.9.2/js/zui.min.js" charset="utf-8"></script>
    <script src="/js/index_page.js" charset="utf-8"></script>
    <script src="/js/functions.js" charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
  </body>

</html>
